---
title: "versitygwとPHPでローカルS3環境を試す"
emoji: "🌿"
type: "tech"
topics:
  - "php"
published: true
published_at: "2025-12-23 10:02"
publication_name: "kaonavi"
---

この記事は [カオナビ Advent Calendar 2025](https://qiita.com/advent-calendar/2025/kaonavi) シリーズ3 23日目の記事です。

## はじめに

MinIOのDockerイメージの配布を停止しました。

https://gigazine.net/news/20251023-minio-stops-distributing-free-docker-images/

https://github.com/minio/minio/issues/21647

自前でビルドをすることも考えながら代わりを探している時にZennのスクラップの内容が目に止まりversitygwというものを知りました。

https://zenn.dev/fujiwara/scraps/e8db3132db0079

https://github.com/versity/versitygw

そこで今回PHPで操作できるか試してみたいと思います。

## 環境

- PHP 8.5.0

## 諸々の準備

### versitygwの環境を用意

Dockerを使ってversitygwを使える環境を構築する。

```yaml:compose.yaml
services:
  versitygw:
    image: versity/versitygw:v1.0.20
    ports:
      - "7070:7070"
    environment:
      - ROOT_ACCESS_KEY=dummy
      - ROOT_SECRET_KEY=dummy
      - VGW_REGION=ap-northeast-1
    command: posix /data
    volumes:
      - ./data:/data
```

- versitygwは2025/12/23時点の最新バージョンである1.0.20を使う
- 起動時に必要な認証情報を環境変数（ROOT_ACCESS_KEY、ROOT_SECRET_KEY）で指定する（値はなんでもいいはず）
- 起動時にリージョンも指定しておく（未指定だと**us-east-1**になる）
- volumesにはアップロードしたファイルを配置する先を指定しておく
- commandには起動時に実行するコマンドを指定する

### PHPのサンプルコード

PHPからS3の操作を行うために`aws-sdk-php`を使うのでインストールする。

```bash
$ composer require aws/aws-sdk-php
```

今回はバージョン3.369.0を使います。（インストール時点の最新バージョンでした。）

```bash
$ composer info | grep aws-sdk-php
aws/aws-sdk-php               3.369.0 AWS SDK for PHP - Use Amazon Web Services in your PHP project
```

```php:s3.php
<?php

require_once 'vendor/autoload.php';

use Aws\S3\S3Client;
use Aws\S3\Exception\S3Exception;

$config = [
    'region' => 'ap-northeast-1', // VGW_REGIONに指定した値
    'version' => 'latest',
    'endpoint' => 'http://127.0.0.1:7070',
    'credentials' => [
        'key' => 'dummy', // ROOT_ACCESS_KEYに指定した値
        'secret' => 'dummy', // ROOT_SECRET_KEYに指定した値
    ],
    'use_path_style_endpoint' => true,
];

$s3 = new S3Client($config);

$bucket = 'local-test'; // バケット名
$file = 'hello.txt'; // ファイル名

// バケットの存在を確認し、なければ作成する
try { 
    $s3->headBucket(['Bucket' => $bucket]);
    echo "Bucket '{$bucket}' 存在する。" . PHP_EOL;
} catch (S3Exception $e) {
    echo "Bucket '{$bucket}' 存在しない。作成中..." . PHP_EOL;
    $s3->createBucket(['Bucket' => $bucket]);
    $s3->waitUntil('BucketExists', ['Bucket' => $bucket]);
    echo "Bucket '{$bucket}' 作成完了。" . PHP_EOL;
}

// アップロード
$result = $s3->putObject([
    'Bucket' => $bucket,  
    'Key' => $file,
    'Body' => 'hello world!!', 
]);

echo 'ファイルのURL => ' . $result['ObjectURL'] . PHP_EOL;
```

大事なところは`$config`にはS3のパス形式に対応させるために**endpoint**と**use_path_style_endpoint**にそれぞれ値を指定する。
今回の検証では実際のS3のURL（バーチャルホスト形式）とは異なりパス形式（IPアドレスを指定）で行うためです。

## 確認

```bash
$ php s3.php
Bucket 'local-test' 存在しない。作成中...
Bucket 'local-test' 作成完了。
ファイルのURL => http://127.0.0.1:7070/local-test/hello.txt
```

初回なのでバケットを作成してから、ファイルをアップロードしていますね。

アップロード済みか確認してみます。

```bash
$ find data                     
data
data/local-test
data/local-test/.sgwtmp
data/local-test/hello.txt

$ cat data/local-test/hello.txt
hello world!!
```

ファイルが存在し、PHPのサンプルコードで指定した内容が表示しましたね。

追加でPHPのコードに以下を追加して実行してみます。

```php
// 内容の取得
$result = $s3->getObject([
    'Bucket' => $bucket,  
    'Key' => $file,
]);

echo 'ファイルの内容 => ' . $result['Body'] . PHP_EOL;

// ファイルの削除
$s3->deleteObject([
    'Bucket' => $bucket,  
    'Key' => $file,
]);
echo "ファイル '{$file}' を削除しました。" . PHP_EOL;
```

```bash
$ php s3.php                   
Bucket 'local-test' 存在する。
ファイルのURL => http://127.0.0.1:7070/local-test/hello.txt
ファイルの内容 => hello world!!
ファイル 'hello.txt' を削除しました。
```

2回目なのでバケットはすでにあるので作成処理は動かないです。
アップロードした内容を表示し、最後にファイルも消していますね。

```bash
$ find data
data
data/local-test
data/local-test/.sgwtmp
```

消えていることも確認できました。

## まとめ

今回お試しでversitygwを使ってみたところ小規模なら簡単に動きました。
実際にMinIOの代わりになるかはわからないですが、選択肢の1つとして考えてもいいかもしれないですね。

最後に今回作成したサンプルコードは以下にあります。
https://github.com/naopusyu/php-versitygw-s3
