---
title: "Rectorを使って返す型にvoidを付ける"
emoji: ""
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [
  "php",
  "rector"
]
published: false
---

## はじめに

https://github.com/rectorphp/rector

## 環境

- PHP 8.4.4

## インストール

READMEに書かれている手順でインストールする。

```
composer require rector/rector --dev
```

この記事を書いている時点でのバージョンは**2.0.9**です。

```
% ./vendor/bin/rector --version
Rector 2.0.9
```

## Rectorの初期化

まずはrector.phpを作るためにvendor/bin/rectorを実行する。
実行すると、rector.phpがないと言われるので、yesと入力し作成する。

```
% ./vendor/bin/rector

 No "rector.php" config found. Should we generate it for you? [yes]:
 > yes 


 [OK] The config is added now. Re-run command to make Rector do the work!

```

作成したrector.phpをつぎのように書き換える。

```php
<?php

declare(strict_types=1);

use Rector\Config\RectorConfig;
use Rector\TypeDeclaration\Rector\Class_\AddTestsVoidReturnTypeWhereNoReturnRector;
use Rector\TypeDeclaration\Rector\ClassMethod\AddVoidReturnTypeWhereNoReturnRector;

return RectorConfig::configure()
    ->withPaths([
        __DIR__ . '/src',
        __DIR__ . '/tests',
    ])
    ->withRules([
        AddTestsVoidReturnTypeWhereNoReturnRector::class,   // PHPUnitテストメソッドにvoidをつける
        AddVoidReturnTypeWhereNoReturnRector::class,        // voidをつける
    ]);
```

今回利用するルールはつぎの2つ

PHPUnitのテストメソッドにvoidをつける

https://github.com/rectorphp/rector/blob/main/docs/rector_rules_overview.md#addtestsvoidreturntypewherenoreturnrector

voidをつける

https://github.com/rectorphp/rector/blob/main/docs/rector_rules_overview.md#addvoidreturntypewherenoreturnrector


後者のルールを使うことでPHPUnitのテストメソッドに対応できる。
前者のルールを使うのは、testsディレクトリにテストクラスとテスト以外のクラスが共存している場合にテストクラスのみに対象を絞りたい場合に使うことを想定していると思われる。（想像なので実際は違うかもしれない）


## 実行

適当に用意した以下のサンプルコードに対して実行してみます。

```php:src/A.php
<?php

class A {
    public function test() {
        return;
    }
}
```

```php:tests/ATest.php
<?php

class ATest extends \PHPUnit\Framework\TestCase
{
    public function test()
    {
        $this->assertSame(1, 1);
    }
}
```

`--dry-run`をつけることでまずは修正されるか確認してみる。
検査対象のディレクトリはrector.phpに書いたので省略する。

vendor/bin/rector process --dry-run

```
rector % ./vendor/bin/rector process --dry-run
 2/2 [▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓] 100%
2 files with changes
====================

1) src/A.php:0

    ---------- begin diff ----------
@@ @@
 <?php

 class A {
-    public function test() {
+    public function test(): void {
         return;
     }
 }
    ----------- end diff -----------

Applied rules:
 * AddVoidReturnTypeWhereNoReturnRector


2) tests/ATest.php:1

    ---------- begin diff ----------
@@ @@

 class ATest extends \PHPUnit\Framework\TestCase
 {
-    public function test()
+    public function test(): void
     {
         $this->assertSame(1, 1);
     }
    ----------- end diff -----------

Applied rules:
 * AddVoidReturnTypeWhereNoReturnRector

 [OK] 2 files would have been changed (dry-run) by Rector

```

想定通りの結果なら`--dry-run`なしで実行し、修正を適用する。

vendor/bin/rector process 

```
rector % ./vendor/bin/rector process
 2/2 [▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓] 100%
2 files with changes
====================

1) src/A.php:0

    ---------- begin diff ----------
@@ @@
 <?php

 class A {
-    public function test() {
+    public function test(): void {
         return;
     }
 }
    ----------- end diff -----------

Applied rules:
 * AddVoidReturnTypeWhereNoReturnRector


2) tests/ATest.php:1

    ---------- begin diff ----------
@@ @@

 class ATest extends \PHPUnit\Framework\TestCase
 {
-    public function test()
+    public function test(): void
     {
         $this->assertSame(1, 1);
     }
    ----------- end diff -----------

Applied rules:
 * AddTestsVoidReturnTypeWhereNoReturnRector

 [OK] 2 files have been changed by Rector

```

修正が適用されていればvendor/bin/rector process を再度実行すると対象は無しになっています。

```
% ./vendor/bin/rector process
 2/2 [▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓] 100%

 [OK] Rector is done!

```

これで大丈夫ですね。

## まとめ

Rectorを使えば1つ1つ確認する必要もなく一括で対応することができます。
今回はvoidを付けるを試しましたが別のルールではPHPDocの内容をもとに引数の型や返す型を設定もできるので活用してみるもの良いかもしれないです。

