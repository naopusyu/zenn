---
title: "Laravelã§N + 1ã‚’æ¤œçŸ¥ã—ãŸéš›ã«ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã™ã‚‹"
emoji: "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦"
type: "tech"
topics:
  - "laravel"
  - "php"
published: true
published_at: "2023-10-29 07:43"
---

## ã¯ã˜ã‚ã«

ä»Šå›`Laravel Query Detector`ã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ã£ã¦N+1ã‚’æ¤œçŸ¥ã—ãŸéš›ã«ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã—ã¦ã¿ã¾ã™ã€‚
https://github.com/beyondcode/laravel-query-detector

## ç’°å¢ƒ

- PHP 8.2.12
- Laravel 10.29.0

## äº‹å‰æº–å‚™

ä»Šå›ã®æ¤œè¨¼ã«ä½¿ã†ãƒ†ãƒ¼ãƒ–ãƒ«ã‚„Eloquentãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹ã‚’äº‹å‰ã«ä½œæˆã—ã¦ãŠãã¾ã™ã€‚

### ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹usersãƒ†ãƒ¼ãƒ–ãƒ«ã¨1å¯¾å¤šã§ç´ã¥ããƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ

:::details database/migrations/2023_10_28_153502_create_tasks_table.php
```php:database/migrations/2023_10_28_153502_create_tasks_table.php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('tasks', function (Blueprint $table) {
            $table->id();
            $table->unsignedBigInteger('user_id');
            $table->string('title');
            $table->timestamps();
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('tasks');
    }
};
```
:::

### Eloquentãƒ¢ãƒ‡ãƒ«ã‚¯ãƒ©ã‚¹

:::details app/Models/Task.php
```php:app/Models/Task.php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Relations\BelongsTo;
use Illuminate\Database\Eloquent\Model;

class Task extends Model
{
    use HasFactory;

    public function user(): BelongsTo
    {
      return $this->belongsTo(User::class);
    }
}
```
:::

::: details database/factories/TaskFactory.php
```php:database/factories/TaskFactory.php
<?php

namespace Database\Factories;

use Illuminate\Database\Eloquent\Factories\Factory;
use Illuminate\Support\Str;

/**
 * @extends \Illuminate\Database\Eloquent\Factories\Factory<\App\Models\Task>
 */
class TaskFactory extends Factory
{
    /**
     * Define the model's default state.
     *
     * @return array<string, mixed>
     */
    public function definition(): array
    {
        return [
            'title' => Str::random(10),
        ];
    }
}
```
:::

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ç”¨æ„ã•ã‚Œã¦ã„ã‚‹Userãƒ¢ãƒ‡ãƒ«ã«ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®šã‚’è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚

```php:app/Models/User.php
use Illuminate\Database\Eloquent\Relations\HasMany;

class User extends Authenticatable
{
    public function tasks(): HasMany
    {
        return $this->hasMany(Task::class);
    }
}
```

### ãƒ‡ãƒ¼ã‚¿ä½œæˆ

`tinker`ã‚’ä½¿ã£ã¦ä¸‹è¨˜ã‚’å®Ÿè¡Œã—ã€usersãƒ†ãƒ¼ãƒ–ãƒ«ã¨ç´ã¥ãtasksãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½œã£ã¦èµ·ãã¾ã™ã€‚

```php
User::factory()
    ->has(Task::factory()->count(10))
    ->count(10)
    ->create();
```

### N+1ãŒèµ·ãã‚‹ã‚³ãƒ¼ãƒ‰

welcomeãƒšãƒ¼ã‚¸ã®ãƒ«ãƒ¼ãƒˆã«æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã‚’ä»•è¾¼ã‚“ã§ã¿ã¾ã™ã€‚

```php:routes/web.php
Route::get('/', function () {
    $tasks = Task::all();
    foreach ($tasks as $task) {
        $task->user->id;
    }
    return view('welcome');
});
```

## ä½¿ã„æ–¹

### ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
composer require beyondcode/laravel-query-detector --dev
```

ã“ã®è¨˜äº‹ã§ä½¿ã†ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯**1.7.0**ã§ã™ã€‚

```
$ composer show | grep beyondcode/laravel-query-detector   
beyondcode/laravel-query-detector  1.7.0    Laravel N+1 Query Detector
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãŠãã¾ã™ã€‚

```
php artisan vendor:publish --provider="BeyondCode\QueryDetector\QueryDetectorServiceProvider"
```

### ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã™ã‚‹è¨­å®š

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã™ã‚‹è¨­å®šã«ãªã£ã¦ã„ã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ãŒã€
ãªã£ã¦ã„ãªã„å ´åˆã¯ã‚³ãƒ”ãƒ¼ã—ãŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ`config/querydetector.php`ï¼‰ã®å†…å®¹ã‚’æ¬¡ã«æ›¸ãæ›ãˆã¾ã™ã€‚

```php:config/querydetector.php
    'output' => [
        \BeyondCode\QueryDetector\Outputs\Log::class,ã€€// <- è¿½è¨˜ã™ã‚‹
    ]
```

ã¾ãŸã€.envãƒ•ã‚¡ã‚¤ãƒ«ã®`APP_DEBUG`ã«`true`ã‚’è¨­å®šã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

## ãŠè©¦ã—

äº‹å‰æº–å‚™ã§ç”¨æ„ã—ãŸwelcomeãƒšãƒ¼ã‚¸ã«ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚Œã°
`storage/logs/laravel-yyyy-mm-dd.log`ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‡ºæ¥ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã®ã§
ä¸­èº«ã‚’ç¢ºèªã™ã‚‹ã¨æ¬¡ã®ã‚ˆã†ãªå†…å®¹ãŒå‡ºåŠ›ã—ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã€‚

```:storage/logs/laravel-yyyy-mm-dd.log
[yyyy-mm-dd XX:XX:XX] local.INFO: Detected N+1 Query  
[yyyy-mm-dd XX:XX:XX] local.INFO: Model: App\Models\Task
Relation: user
Num-Called: 100
Call-Stack:
ã€œã€œã€œ ä»¥é™ã¯ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹ã®å†…å®¹ ã€œã€œã€œ
```

## ã¾ã¨ã‚

çŸ¥ã‚‰ãªã„é–“ã«N+1ã®ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ã„ã‚‹å ´åˆãŒã‚ã£ãŸã‚Šã™ã‚‹ã®ã§ã€
ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã—ã¦ãŠã‘ã°CIã§ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦N+1ã®å ´æ‰€ã‚’æ¢ã—å‡ºã›ãŸã‚Šã™ã‚‹ã‹ã‚‰ä¾¿åˆ©ã‹ãªã£ã¦æ€ã„ã¾ã™ã€‚

ã¾ãŸã€ä»Šå›ã¯è©¦ã—ã¦ã„ãªã„ã§ã™ãŒã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ã™ã‚Œã°å‹•ä½œç¢ºèªä¸­ã§ã‚‚è¦‹ã¤ã‘ã‚‹ã“ã¨ãŒã§ãã‚‹ã®ã§
è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®`output`é…åˆ—ã«`\BeyondCode\QueryDetector\Outputs\Console::class`ã‚’è¿½è¨˜ã—ã¦ãŠãã®ã‚‚ã„ã„ã‹ãªã£ã¦æ€ã„ã¾ã™ã€‚

