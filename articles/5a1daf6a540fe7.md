---
title: "Laravel11 migrateコマンド/schemaコマンド"
emoji: "🛒"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [
    "laravel",
    "php"
]
published: false
published_at: "2024-12-15 06:00"
---

この記事は [Laravel11にあるArtisanコマンドを全部調べる Advent Calendar 2024](https://adventar.org/calendars/10674) 15日目の記事です。

今回はmigrateコマンド/schemaコマンドについて調べました。

migrateコマンドについては以前にも調べているが、オプションなどを含めて調べ直した。

https://zenn.dev/naopusyu/articles/ac9b32191fe8fd

## 環境

- PHP 8.4.1
- laravel/laravel 11.3.3
- laravel/framework 11.33.2

## migrate

マイグレーションを実行する。

```
php artisan migrate
```

実行すると未実行のマイグレーションを実行します。

本番環境（.envのAPP_ENVがproduction）で実行すると実行確認のメッセージが表示します。

![](/images/5a1daf6a540fe7/1.png)

Yesを選択することでマイグレーションが実行します。

| オプション | 説明 |
| --- | --- |
| `--database[=DATABASE]` | 接続するデータベースを指定 |
| `--force` | 本番環境で強制的に実行 |
| `--path[=PATH]` | 実行するマイグレーションファイルのパスを指定 |
| `--realpath` | 実行するマイグレーションファイルのパスを絶対パスで指定 |
| `--schema-path[=SCHEMA-PATH]` | スキーマダンプファイルのパスを指定 |
| `--pretend` | 実行するSQLクラスを出力 |
| `--seed` | シーダを実行 |
| `--seeder[=SEEDER]` |　シーダクラスを指定 |
| `--step` | マイグレーションを個別に実行 |
| `--graceful` | 失敗しても強制的に正常終了 |
| `--isolated[=ISOLATED]` | マイグレーションの排他実行 |

- `--database`にはconfig/database.phpに書かれているデータベース接続名を指定できます
未指定の場合はデフォルトのデータベースに接続してマイグレーションを実行します
- 本番環境で`--force`を付けると実行確認を行わないで強制的に実行します
- `--path`を使ってマイグレーションファイルのパスを指定できます ※ 複数指定可能
ここで指定するパスはアプリケーションのベースパス配下を指定する必要がありますが、`--realpath`を一緒に付けると絶対パスで指定もできます
- `--schema-path`を使ってスキーマダンプファイルのパスを指定できます
未指定の場合はdatabase/schema/{データベース接続名}-schema.sqlが指定します
- `--pretend`を付けると実行するSQLが確認できますが、SQLは実行されないです
詳しくは[こちらの記事](https://zenn.dev/naopusyu/articles/c2436e50db8f2a)を読んでみてください。
- `--seed`を付けるとマイグレーションの実行後にシーダを実行します
この時に実行するシーダは`--seeder`を使うことで指定することもできます（指定しない場合はDatabase\Seeders\DatabaseSeederを実行する）
- `--step`を付けるとマイグレーションを一括で実行せず1ファイル、1ファイル順番に実行します
これはマイグレーションのロールバックする時に1ファイルだけ戻す場合に役に立ちます
- `--graceful`を付けるとマイグレーションに失敗しても強制的に正常終了させることができます
- 複数のサーバーで同時にマイグレーションを実行する場合に`--isolated`を付けるとマイグレーションの排他制御が可能になります

## migrate:fresh

すべてのテーブルを削除後にマイグレーションを実行する。

```
php artisan migrate:fresh
```

実行するとdb:wipeコマンドを使ってすべてのテーブルを削除し、そのあとでmigrateコマンドを実行します。

migrateコマンドと一緒で本番環境（.envのAPP_ENVがproduction）で実行すると実行確認のメッセージが表示します。

また、migrate:freshはLaravel11から確認ではなく実行を止めるために\Illuminate\Console\Prohibitableトレイトが用意されています。
こちらを利用すれば本番環境の実行ができなくなります。（書き方次第ではほかの環境でも止めることができます。）

下記が\Illuminate\Console\Prohibitableトレイトを利用して実行した結果です。

```
advent-calendar-2024 % php artisan migrate:fresh

   WARN  This command is prohibited from running in this environment.
```

詳しくはこちらの記事を読んでみてください。
https://zenn.dev/naopusyu/articles/98ca9732f5c700

| オプション | 説明 |
| --- | --- |
| `--database[=DATABASE]` | 接続するデータベースを指定 |
| `--drop-views` | すべてのビューを削除 |
| `--drop-types` | すべてのユーザー定義型を削除 |
| `--force` | 本番環境で強制的に実行 |
| `--path[=PATH]` | 実行するマイグレーションファイルのパスを指定 |
| `--realpath` | 実行するマイグレーションファイルのパスを絶対パスで指定 |
| `--schema-path[=SCHEMA-PATH]` | スキーマダンプファイルのパスを指定 |
| `--seed` | シーダを実行 |
| `--seeder[=SEEDER]` |　シーダクラスを指定 |
| `--step` | マイグレーションを個別に実行 |

:::message
[migrateコマンド](#migrate)、[db:wipeコマンド](https://zenn.dev/naopusyu/articles/e0a0180e3c4c40#db%3Awipe)と同様のオプションが使えます。
:::

- `--database`にはconfig/database.phpに書かれているデータベース接続名を指定できます
未指定の場合はデフォルトのデータベースに接続してマイグレーションを実行します
- `--drop-views`を付けるとすべてのビューも削除します
- `--drop-types`を付けるとすべてのユーザー定義型も削除します（PostgreSQLのみ）
- 本番環境で`--force`を付けると実行確認を行わないで強制的に実行します
ただし、さきほどの\Illuminate\Console\Prohibitableトレイトを利用していると`--force`をつけても実行できないです
```
advent-calendar-2024 % php artisan migrate:fresh --force

   WARN  This command is prohibited from running in this environment.
```
- `--path`を使ってマイグレーションファイルのパスを指定できます ※ 複数指定可能
ここで指定するパスはアプリケーションのベースパス配下を指定する必要がありますが、`--realpath`を一緒に付けると絶対パスで指定もできます
- `--schema-path`を使ってスキーマダンプファイルのパスを指定できます
未指定の場合はdatabase/schema/{データベース接続名}-schema.sqlが指定します
- `--seed`を付けるとマイグレーションの実行後にシーダを実行します
この時に実行するシーダは`--seeder`を使うことで指定することもできます（指定しない場合はDatabase\Seeders\DatabaseSeederを実行する）
- `--step`を付けるとマイグレーションを一括で実行せず1ファイル、1ファイル順番に実行します
これはマイグレーションのロールバックする時に1ファイルだけ戻す場合に役に立ちます

## migrate:install

migrationsテーブルを作成する。

```
php artisan migrate:install
```

:::message
このコマンドはmigrateコマンドから実行するので直接実行する機会はないと思います。
:::

実行するとmigrationsテーブルを作成します。
作成するテーブル名はconfig/database.phpで指定しているので別の名前に変更することもできます。

```php:config/database.php
    'migrations' => [
        'table' => 'migrations', // ここを書き換えるとテーブル名を変えることができる
        'update_date_on_publish' => true,
    ],
```

| オプション | 説明 |
| --- | --- |
| `--database[=DATABASE]` | 接続するデータベースを指定 |

- `--database`にはconfig/database.phpに書かれているデータベース接続名を指定できます
未指定の場合はデフォルトのデータベースに接続してマイグレーションを実行します

## migrate:refresh
## migrate:reset
## migrate:rollback
## migrate:status

